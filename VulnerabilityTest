package TestCases;

import clientAPI.FactoryRequest;
import clientAPI.ResponseInfo;
import io.qameta.allure.*;
import org.json.JSONObject;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import utils.ConfigOWASP;

public class VulnerabilityTest {

    String idScanner;
    ResponseInfo resposeInfo;
    @Test
    @DisplayName("Verify the login using valid credentials")
    @Description("This test case is to verify the login functionality when we use valid data")
    @Link("www.azuredevops.tesplans/TCID12321") //ejemplo de lo que se puede agregar en link
    @Issue("BUGID5654") //ejemplo de info del bug
    public void scanningVulnerabilityTest() throws InterruptedException {
        this.initScanner();
        this.checkProgressSanner();
    }

    @AfterEach
    public void generateReport(){
        // genero el reporte
        System.out.println("INFO> Scanner 100%");
        System.out.println("INFO> ***** generacion de reporte");
        resposeInfo= FactoryRequest.make("get").send(ConfigOWASP.GENERATE_REPORT,"");
        this.attachDocuments("Reporte OWASP",resposeInfo.getBody());
    }

    @Attachment(value="{0}",type = "text/html")
    public String attachDocuments(String name,String htmlReport){
        return htmlReport;
    }


    @Step("Iniciando escaneo con OWASP ZAP")
    public void initScanner(){
        resposeInfo = new ResponseInfo();
        resposeInfo= FactoryRequest.make("get").send(ConfigOWASP.START_SCANER+"https://todoist.com/","");
        this.idScanner= new JSONObject(resposeInfo.getBody()).getString("scan");
    }
    @Step("Monitoreando a que llegue al 100%")
    public void checkProgressSanner() throws InterruptedException {
        //porcentage del escaneo 100%
        resposeInfo= FactoryRequest.make("get").send(ConfigOWASP.PROGRESS_SCANER+idScanner,"");
        String percentage= new JSONObject(resposeInfo.getBody()).getString("status");
        while (!percentage.equals("100")){
            Thread.sleep(15000);
            resposeInfo= FactoryRequest.make("get").send(ConfigOWASP.PROGRESS_SCANER+idScanner,"");
            percentage= new JSONObject(resposeInfo.getBody()).getString("status");
            System.out.println("INFO> percentage: "+percentage+"%");
        }
    }

}
